```json lw-blog-meta
{"title":"Github Actions 踩坑记","date":"2020-08-15","brev":"我的个人博客网站从Gitlab迁移到Github过程中遇到的一些坑。","tags":["DevOps"],"path":"blog/2020/200815-GithubActions踩坑记.md"}
```


## 以前的运维架构

- Github
    + 是最重要的社区，因此我的博客内容在这里开源
- Gitlab
    + 我的前后端代码闭源托管在这里
    + 需求记录在issue中，方便地直接用issue开branch
    + 作为自建Git服务的首选之一，用它肯定没错
    + 前两年只有Gitlab有完善的Git+CI整体解决方案

## 为什么要迁移

1. `Github-Actions` 作为新潮儿有后发技术优势，而且又背靠微软这棵大树，我觉得靠谱。
2. 在issue中记录需求，在多项目体系中的确是很糟糕的体验（经常一个需求要同时在两个或者更多地方建立issue），因此考虑将需求管理从代码项目中独立出来。
3. 有现成的、成熟的需求管理平台 `Trello` (或者`Jira`)，经过使用体验，我认为完全可以满足我的需求。
4. 同样作为自建Git服务，轻量的 `Gitea` 可能会是未来更加潮流的选择，因此坚守在 `Gitlab` 未必是明智的。（我的意思只是，未来可能百家争鸣，但是**在当下，我依然将Gitlab视作自建Git服务最佳的选择**）
5. 代码分布在两个平台多少还是有些不便，如果 Github 和 Gitlab 二选一的话，肯定只能选择前者。

简单来说，就是新的需求有更好的工具可以实现，因此无情地放弃了旧的平台。

emmmm…… 别怪我~ 毕竟互联网的世界，就是这么无情~

## 1号坑: 国内网速受限

项目构建完成后，可以将成品（镜像）放在`github-packages`中。这个东西有没有很熟悉？对，很多梯子工具的安装包就是放在这个地方，因此对这个地址的访问就被施加了魔法，慢得令人发指——实测腾讯云下载速度 5KB/s.

因此我将魔爪伸向了另一个可怜的家伙——`Docker-hub`。这玩意主要是托管在国外的，但是在国内有一些神奇的加速（至少比github快得多多多了）。因此我使用了我宝贵的唯一的那个private仓库名额，将所有成品镜像都传到这里。这样无论是构建时的上传速度、还是部署时的下载速度都能够得到保证。实测腾讯云下载速度超过 100KB/s。

## 2号坑: secrets限制

参考在 Gitlab 上的方式，我给我的项目在 github 上建立了一个同名的 organization 叫 `lewinblog`。很多操作都是抄过来的，进展很顺利，直到我开始设置 secrets.

小里小气的 Github 说：只有付费的组织才能在组织层面设置 secrets，免费组织只能在项目上分别设置。

因此我非常丑陋地将各种 token 在各个项目中分别设置了一遍。不过这个小毛病无伤大雅。

还有一点要吐槽的是，github 的 secret 设置后就不能再查看了，只能输入新的值去更新。这点特性也给我造成了一些小麻烦。

## 3号坑: 镜像命名

`Github-packages` 中支持存放 docker 镜像，这个是个挺好的事情（也是个必须的特性，否则我不会选择 github）。

但是有个奇怪的行为是，镜像的最后名称 `image_name` 必须是在组织中唯一的，而不是在项目中唯一，例如以下两个镜像是不能共存的，因为他们的名字 `prod` 重复了：

```text
lewinblog/frontend/prod:latest
lewinblog/backend/prod:latest
```

说实话这个行为真的挺奇怪的。因此我只能加一些冗余信息进去，挺丑的：

```text
lewinblog/frontend/frontend:latest
lewinblog/backend/backend:latest
```

## 一个其他的坑

在重启 swarm 服务时遇到一个非常诡异的事情。

我的`mongo:4.2.8`的服务无论如何都起不来了。没有改任何文件，只是简单地重启了 stack 之后，这个服务就永远地挂掉了。

表现形式是，服务一直处于 preparing 状态，没有任何日志，也没有任何异常，当然也没有生成任何容器。

调查了很久，尝试各种控制变量实验，尝试重启docker，甚至重启机器，也找不到原因在哪。最后尝试更新了镜像，下载了最新的 4.4.0 版本，运行正常了！

另外发现个意外之喜——腾讯云服务器上的docker可以用阿里云的镜像加速服务！之前我以为他们会互相屏蔽的。不得不说，阿里云在开源事业上还真的挺良心的。

## 小结

总体来说， github-actions 是个令我满意的 CI 工具。其实它除了能做传统的持续集成功能外，还能做一些很新奇的功能，比如 处理issue 这类与开发并无太大关联的小功能，可能不太实用，但是可能会挺好玩。以后有时间了再尝试一下~

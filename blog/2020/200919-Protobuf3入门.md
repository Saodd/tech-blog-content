```yaml lw-blog-meta
title: "Protocol Buffers 3 入门教程"
date: "2020-09-19"
brev: "【弃坑】又是一个没有中文官方教程的技术。"
tags: [TODO]
```

## 弃坑感言

Protobuf 居然对 Golang 的支持都不甚友好，这东西真的能有前途吗？

还是老老实实用json吧……

## 前言

Protocol Buffer 是一个语言无关、平台无关的数据通信格式。因此教程会分为两个部分，一是对于 protobuf(3) 自身的教程，二是在Go语言使用它的教程。

原文地址: [Language Guide (proto3)](https://developers.google.com/protocol-buffers/docs/proto3)

## 1. 定义一个消息类型

假如你想定义一个搜索请求的消息格式，其中包含查询字符串、分页页码、分页大小三个内容，可以用protobuf定义如下：

```
syntax = "proto3";

message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 result_per_page = 3;
}
```

- 第一行表明了你正在使用`proto3`的语法，如果不指定的话则会被默认为是`proto2`，它必须是除了空行、除了注释行之外的第一行。
- `SearchRequest`这个「消息`message`」定义了三个字段（键值对），每个字段都有名字和类型。

### 字段类型

上面的 int32 和 string 都是「纯量类型`scalar types`」。除此之外还有复合类型`composite types`。

### 字段编号

注意到没，每个字段的定义后面还跟了一个唯一编号。这个编号是用来决定字段在二进制格式中的排列顺序的。因此不能随便更改。

需要注意的是，序号 1-15 需要占用1个字节（包括序号和类型），16-2047 则需要占用两个字节。因此尽量保留 1-15 序号给你最常用的字段。最好还要记得在序号中留出一些空档以方便未来添加字段。

序号可用值的范围是 1-536870911 （2的29次方减一），并且排除 19000-19999 这一段。

### 字段规则

- singular: 允许该字段出现0次或1次；
- repeated: 允许该字段出现0次或任意次，有顺序。

### 定义多个消息类型

可以在一个 `.proto` 文件中定义多个消息类型。这允许你把一些相关的消息类型放在一起。

### 添加注释

使用C语言的注释风格，即 `//` 和 `/* ... */`

### 保留字段

有时你可能还是会删除，或者临时注释掉某些字段。可是如果你的同事在不知情的情况下复用了你之前所使用的字段编号，那么可能会引发问题。

因此可以用保留字段。可以写序号，或者写字段名。

```
message Foo {
  reserved 2, 15, 9 to 11;
  reserved "foo", "bar";
}
```

### .proto 文件生成了什么？

使用编译工具来处理`.proto`文件，会生成与你选择的语言对应的代码。

- 对于Go来说，会生成一个`.pb.go`文件，其中给你定义的每个protobuf消息类型都有对应的结构体。

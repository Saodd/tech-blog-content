```yaml lw-blog-meta
title: 'Gitlab工作流'
date: "2020-12-08"
brev: "我总结的一套利用Gitlab来管理代码的工作流程。"
tags: ["DevOps"]
```

## 基础流程

1. 建立issue。
    1. 非常类似于Trello，也提供了看板和列表的功能。
    1. 与Trello不同的是，这里可以更直接地与代码关联起来，但是缺点是每个issue都与一个Repo绑定，如果一个产品用到多个Repo（比如典型的前端、后端、运维三个Repo的情况），用这个issue就不行了。
    1. 比Trello多出来的一个好用的功能是Milestone
    1. 可能的改进方案：配合Jira使用
2. 选定一个issue创建MR，进入开发阶段
    1. 一个值得学习的地方：用一个编号把需求卡片和代码分支关联起来。
    1. 我的Trello实践：自己编号
    1. 可能的改进方案：用Jira
3. 写代码，包括单元测试代码
3. 提交代码，在MR上取消标记Draft状态
    1. 比Gerrit强太多的一点：本地的分支可以与远端一致，不要用`refs/for/`把它人为地割裂开。
5. 测试
    1. 自动化单元测试可以等CI，CI运行结果会反映在MR详情页上。如果不通过，Merge按钮会变成红色并有相应的提示。
    1. 如果要人工测试，可以结合Jenkins，把这个branch部署到测试环境中。测试结果可以在MR页面点approve或者留言
6. Code Review
    1. 默认查看整个分支的代码，如果需要也可以点进每个commit去看
    1. 也可以看到每次提交与上一次提交的区别
    1. 总之，gerrit能做的这里都能做，而且更美观和丰富
    1. 我记得应该也有投票机制了，是不是只有EE版本才有？
7. 上线
    1. 对于不需要多版本同时维护的代码，有一个 `master` 分支就可以了（实际上 `Gerrit` 里也就相当于只有master这一个分支），其他的都是临时分支。
   
> 注：我这里并不是在吹捧Jira，我的意思只是它可以作为一个综合性的工具来使用。它很重，有优点也有缺点。

## 进阶：协作流程

1. 两个人分别在两个分支上工作（很重要！不要在另一个人的分支上发展你自己的分支）
1. 需要合并测试时，起一个新的分支，用cherry-pick（或者rebase）来把两个分支的代码加在一起
1. （两个人做一个需求这个事情应该是不太合理的）

## 碎碎念

不要用 fork ！！ fork 是为开源项目设计的，团队内部请务必用单Repo！！用分支来管理不同团队成员的代码！！

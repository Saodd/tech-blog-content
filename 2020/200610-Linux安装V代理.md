```yaml lw-blog-meta
title: Linux安装V代理
date: "2020-06-10"
brev: 现在可用的工具无非就是两种，Sxx和Vxxx。前者更流行但是受到的干扰也多，后者更先进但是需要更多一点的折腾。我们看一下在Ubuntu环境下如何进行安装和配置Vxxx。
tags: [运维]
```


## 简介

Vxxx 的源代码和安装包都可以在 Github 上找到。

windows 和 macos 上有现成的可用的带GUI的工具，直接下载安装就好了。但是在linux环境下配置有点麻烦。

其实这东西分为两部分，最重要的是核心(core)及附带的配置文件，我们平常用的GUI只是一个便利的配置工具而已。

## 安装方法

1. 通过官方提供的`go.sh`脚本来安装。这个的最大问题是网速太慢，不过如果你已经有现成的代理工具可以使用的话，那用这个方法还是不错的。另一个缺点就是通过脚本安装可能会让有洁癖的人心里不太舒服，毕竟没看过源码也不知道它到底把文件放在哪里了。

2. 下载二进制文件。直接通过 github-release 来下载会慢到哭……可以考虑通过分流的 github-repo 来进行下载，速度好像稍微好一些。通过这种方式有个好处，就是我们可以利用一些离线下载的工具来帮助提速（懂的就懂不懂算了）。还有一种取巧的方式是通过 ubuntu 自带的 snap 包管理工具来下载，不过这种方式虽然网速好一点，但是安装包也更大了，未必更快。

    下载之后把压缩包解压，原样地放在一个文件夹里就好了。

3. 通过 docker 来安装。这种方式最安全，通过docker的隔离，可以完全保证这个工具对你的系统无害。我们先配置好国内的 docker 镜像加速，然后拉取指定的镜像，你会惊喜地发现速度非常非常快！这个方式的问题在于，docker 安装的时候网速也比较感人……而且需要一定的开发知识才能熟练运用。

## 使用方法

### 1. 本地二进制文件

我们第一次使用的时候，建议通过终端来运行 `vxxx` 那个文件。之后配置熟练了，再考虑右键点击运行（即挂在桌面进程下运行）。

配置文件的最佳设置方式，是将其他平台上的GUI工具生成出来的配置文件直接粘贴过来。我就是这么干的。不建议从零开始手动配置，太慢了，请自行查阅官方文档。

我们通过一些手段将现有的配置文件拷贝到ubuntu机器上。然后记得先在 `config.json` 配置文件中修改日志相关的字段，一开始我们可以设置为全部输出，便于我们定位问题：

```json
"log": {"loglevel": "debug"}
```

然后还有比较重要的设置项是 `inbounds`，它决定了工具的入口。

```json
"inbounds": [
{
    "listen": "127.0.0.1",  # 如果需要向局域网开放，则设为0.0.0.0，下同
    "protocol": "socks",  # 指定的协议，下同
    "settings": {
        "ip": "127.0.0.1",
        "auth": "noauth",
        "udp": false
    },
    "tag": "socksinbound",
    "port": 1081  # 端口自选，下同
},
{
    "listen": "127.0.0.1",
    "protocol": "http",  # 这个协议更常用
    "settings": {
        "timeout": 0
    },
    "tag": "httpinbound",
    "port": 1082
}
],
```

至于 `outbounds` 部分，比较复杂，具体的设置要取决于你的服务器或者购买的线路是如何设定的。这也是为什么我建议直接使用现成的配置文件拷贝过来使用。

配置文件设置完了以后，我们运行那个 vxxx 的可执行文件（可能需要先 chmod 一下）。运行后显示 Read config: xxxxx 然后没有报出异常，那就说明启动成功了。

### 2. Docker的用法

Vxxx 这个工具，实质上就是一个普通的 web 服务器而已，监听某个端口，做一些事情，然后返回结果。所以 docker 的配置命令也非常简单。

首先准备一个配置文件，这个跟前面是完全一样的（或者说配置文件是平台无关的）。

然后我们要启动一个容器，开放两个端口，然后把配置文件挂载进去。这里我们把镜像叫做 `vxxx` 然后把里面那个可执行文件称为 `vyyy`：

```shell-session
docker run --rm -it \
    -p 1081:1081 -p 1082:1082 \
    -v /path/to/your/config.json:/config.json \
    vxxx vyyy -c /config.json
```

这个镜像实质上就只是将二进制文件放进了docker中而已，除了启动的方式不同，其他的都一样。

### 3. 系统设置

vxxx 的核心组件运行起来了，接下来我们要在系统上做一些设置：

1. 在ubuntu的 系统设置-网络-网络代理 中，选择手动，然后分别设置 http，https，socks三个代理。
2. 如果只想对浏览器起作用的话，可以使用浏览器插件。比如Chrome环境下的 `SwitchyOmega`。
3. 在命令行模式下需要手动设置环境变量，如`export http_proxy=http://127.0.0.1:1082;export https_proxy=http://127.0.0.1:1082;`。为了方便起见，可以将这些环境变量写在一个 sh 脚本中，或者放在 bash.profile 等文件中。

接下来我们就可以访问一些不存在的网站啦。

## 小结

代理工具的核心其实就是一个简单的端口转发。不用把它想得过于复杂。

如果设备比较多的话，还是建议直接做一个路由代理。
